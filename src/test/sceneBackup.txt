#include "stdafx.h"
#include "system/effects/yanePlaneEffectBlt.h"
#include "CJoeySceneFactory.h"
#include "CApp.h"

// 1. Scene enumeration
enum SCENE {
    SCENE1,
    SCENE2,
    SCENE3,
    SCENE_ISEND  // "Exit?" confirmation scene
};

// 2. Create base scene (inherit from IScene and use namespace)
class CBaseScene : public IScene {
protected:
    CApp* app;  // Store reference to main app
public:
    void SetApp(CApp* _app) { app = _app; }
};

// 3. Create scenes
class CSceneTest : public CBaseScene {
public:
    virtual void OnInit() {
		bgPlane->Load("data/y/try/end_e.bmp");
        
        // Create text planes
        textPlane.GetFont()->SetText("I am scene 1!");
        textPlane.UpdateTextAA();

        // Reset input to prevent double triggers
        //app->GetKey()->ResetKey();
		//key.GetKeyData();
		//key.Reset();
    }

    virtual void OnDraw(const smart_ptr<ISurface>& lp) {
		key.Input();

        if (key.IsKeyPush(5)) {  // Space
            // Start transition effect
            ISurfaceTransBlt::CircleBlt1(lp.get(), bgPlane.get(), 0, 0, 255, 0);
		}
        if (key.IsKeyPush(6)) {  // Return
            ISurfaceTransBlt::WhorlBlt1(lp.get(), bgPlane.get(), 0, 0, 255, 0);
            GetSceneControl()->PushScene(SCENE1);
            GetSceneControl()->JumpScene(SCENE3);
            return;
        }

        lp->Clear();
        lp->BltFast(bgPlane.get(), 0, 0);
		CPlane text(&textPlane);
		lp->BltNatural(text,20,500);
    }

private:
    CPlane bgPlane;
    CTextFastPlane textPlane;
	CKey1 key;
};

// Yes/No confirmation scene
class CSceneYesNo : public CBaseScene {
    // ... similar implementation with updated API calls
};

// 4. Create scene factory
smart_ptr<IScene> CMySceneFactory::CreateScene(int nScene) {
    CBaseScene* scene = NULL;
    
    switch ((SCENE)nScene) {
        case SCENE1: scene = new CScene1(); break;
        case SCENE2: scene = new CScene1(); break;
        case SCENE3: scene = new CScene1(); break;
        case SCENE_ISEND: scene = new CSceneYesNo(); break;
        default: return smart_ptr<IScene>(); // Return null on error
    }
    
    if (scene) {
        scene->SetApp(m_app);
    }
    
    return smart_ptr<IScene>(scene);
}

/*
void TEST() {
    // Initialize display
    GetDraw()->SetDisplay(false, 800, 600, 16);

    CFPSTimer timer;
    timer.SetFPS(30);

    // Create scene controller with factory
    smart_ptr<ISceneFactory> factory(new CMySceneFactory(this));
    smart_ptr<ISceneControl> sceneControl(new CSceneControl(factory));
    
    // Start with Scene1
    sceneControl->JumpScene(SCENE1);

    while(IsThreadValid()) {
        // Handle input
        if (GetKey()->IsKeyPush(0)) break; // ESC to exit

        // Handle window close request
        if (m_bWindowClosing) {
            if (sceneControl->GetSceneNo() != SCENE_ISEND) {
                sceneControl->CallSceneFast(SCENE_ISEND);
            }
            m_bWindowClosing = false;
        }

        // Update and draw current scene
        smart_ptr<ISurface> surface = GetDraw()->GetSecondary();
        sceneControl->OnMove(surface);
        sceneControl->OnDraw(surface);

        GetDraw()->OnDraw();
        timer.WaitFrame();
    }
}
*/