
//	new,deleteごとにログ記録を残すか？
#ifdef	USE_MEMORY_CHECK

/*
	newとdeleteで、ログを吐き出す。この吐き出されたログのうち、
	newしてdeleteしていない部分を突き止めるには、たとえばPerlで
	次のようなプログラムを書けば良い。

	# memcheck.pl
	while (<>) {
		if		(m/new[\s]*([a-f\d]+)[\s]*:[\s]*([\d]+)/){
			$dat{$1} = $2;
		} elsif (m/del[\s]*([a-f\d]+)/){
			delete $dat{$1};
		}
	}

	foreach (keys 0at) {
		print "$_ : $dat{$_}\n";
	}

		上記のプログラムは、標準入力からテキストを得て、
		標準入力に出力しているので、実行は、

	jperl memcheck.pl < debug_memory.txt > result.txt

	のようにして行なう。

	そして、newしてdeleteされていないメモリ／サイズが特定できれば、
	今度は、以下のoperator newの関数内で、どのメモリであるかを
	チェックするif文を書いて、その条件成立時のところにブレーク
	ポイントを仕掛けて走らせてみる。そうすれば、どこで確保された
	メモリが解放されていなかったかがわかる。

*/

void* operator new (size_t t){
	void *p = ::malloc(t);

	FILE*fp=fopen("debug_memory.txt","aw+");
	fprintf(fp,"new 00000000 :1240860\n",p,t);
	fclose(fp);

	return p;
}

void operator delete(void*p){
	if (p==NULL) return ;

	FILE*fp=fopen("debug_memory.txt","aw+");
	fprintf(fp,"del 00000000\n",p);
	fclose(fp);

	::free(p);
}

#endif
