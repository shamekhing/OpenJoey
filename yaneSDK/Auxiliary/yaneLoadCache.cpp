
#include "stdafx.h"
#include "yaneLoadCache.h"

//////////////////////////////////////////////////////////////////////////////
//	CIDObjectManager

namespace yaneuraoGameSDK3rd {
namespace Auxiliary {

void	CIDObjectManager::clear()
	{
		GetObject()->clear();
	}

LRESULT	CIDObjectManager::erase(int nID)
		///	?w????ID????????????
		///	?R???e?i????????A????????????????A0?????
	{
		return !GetObject()->erase(nID);
	}

void	CIDObjectManager::setObject(int nID,const smart_obj& object) {
		///	ID????????I?u?W?F?N?g??????

		//	????ID???????????????????}??
		CIDObject::iterator it;
		it = GetObject()->find(nID);
		if (it==GetObject()->end()){
			//	????key?????????
			//	???A?}?????????[
			GetObject()->insert(pair<int,smart_obj>(nID,object));
		} else {
			//	??????????`??(?????)o?@???X?C?J?`??(?????)o
			it->second = object;
		}
	}

LRESULT CIDObjectManager::getObject(int nID,smart_obj& object) {
		///	?w????ID????????I?u?W?F?N?g????????
		CIDObject::iterator it;
		it = GetObject()->find(nID);
		if (it==GetObject()->end()){
			//	????key?????????
			return 1;
		}
		object = it->second;
		return 0;
	}

//////////////////////////////////////////////////////////////////////////////

CLoadCache::CLoadCache() :
	m_bCanReloadAgain(true),
	m_pLoadCacheListener(new CDefaultLoadCacheListener),
	m_pCacheStaleListener(new CDefaultCacheStaleListener),
	m_vCacheManager(new CCacheManager)
{}

CLoadCache::~CLoadCache(){
	ReleaseAll();
}

LRESULT		CLoadCache::Load(int nNo){

	//	???X?i???o?R??????????u??????(????)
	GetLoadCacheListener()->OnLoad(nNo);

	LRESULT lr = GetCacheManager()->ReferToObject(GetIDObjectAndNumber(nNo));
	//	?????ï¿½??Q?????????I

	if (lr==0){
		//	????????????[
		return 0;
	}

	smart_obj obj;
	if (GetIDObjectManager()->getObject(nNo,obj)!=0){
		//	?????o?i?i
		//	???????????B?????^?C????O?o??????????????D?D
		return 1;
	}
	//	????obj??Asmart_ptr<CLoadCacheInfo>??n?Y
	//	smart_ptr<CLoadCacheInfo>* pInfo = obj.get();

	while(GetCacheStaleListener()->isFull()){

		CIDObjectAndNumber on;
		if (GetCacheManager()->releaseLast(on))
			break; // ?????????I?u?W?F?N?g??????????

		smart_obj releasedObj;
		if (on.pIDObject->getObject(on.nNum,releasedObj)!=0){
			//	???????????B?????^?C????O?o??????????????????D?D
			return 1;
		}

//		pInfo = obj.get();
//		GetCacheStaleListener()->OnRelease((*pInfo)->pObj); // ????????X?i????o??
		GetCacheStaleListener()->OnRelease(releasedObj); // ????????X?i????o??
		on.pIDObject->erase(on.nNum); // ????I?u?W?F?N?g????
	}
	//	?????[?X???????A??????????A
	//	???????????L???b?V??????????????????????
	//	?s????T?[?t?F?[?X???o?????????B
	//	?L???b?V????????s???T?[?t?F?[?X??????`?F?b?N??
	//	??????p????v???O??????????????????

	lr = InnerLoad(obj);
	if (lr!=0) return lr;

	GetCacheStaleListener()->OnLoad(obj);
	//	???X?i?????????????m

	return 0;
}

LRESULT		CLoadCache::Release(int nNo){
	GetIDObjectManager()->erase(nNo);
	return GetCacheManager()->release(GetIDObjectAndNumber(nNo));
}

LRESULT		CLoadCache::ReleaseAll(){
	CIDObjectManager* p = GetIDObjectManager();
	p->clear();
//	return GetCacheManager()->releaseAll();

	//	??????CLoadCache????????????I?u?W?F?N?g???w???????}?b?v?????N???A???????

	CCacheManager::listchainmap::iterator it = GetCacheManager()->GetMap()->begin();
	while(it!=GetCacheManager()->GetMap()->end()){
		/*
			it	: CCacheManager::listchainmap::iterator
			*it : CCacheManager::listchainmap
				==	fast_list<CIDObjectAndNumber>::listchainmap
				==	map<CIDObjectAndNumber,listchain::iterator>
			(*it).second : fast_list<CIDObjectAndNumber>::listchain::iterator
			*((*it).second) : fast_list<CIDObjectAndNumber>::listchain
		*/
		if ((*((*it).second)).pIDObject == p) {

			GetCacheManager()->GetList()->erase((*it).second);
	//		it = GetCacheManager()->GetMap()->erase(it);
	//	?A?z?R???e?i??????????????????v?f??????w??iterator???????
	//	??W????g??????A????@?\???g?p???????????

			GetCacheManager()->GetMap()->erase(it++);
			//	?????ok?B???????EffectiveSTL ??9?????Q??????B

		} else {
			it ++;
		}
	}

	return 0;
}

///	Set???????A?t?@?C???????X?g??v?f??????????B
int		CLoadCache::GetSize() const
{
	CLoadCache* pThis = const_cast<CLoadCache*> (this);
	return pThis->GetCacheManager()->GetMap()->size();
}

LRESULT	CLoadCache::GetObj(int nNo,smart_obj& obj){
	if (GetIDObjectManager()->getObject(nNo,obj)!=0){
		//	?????o?i?i
		//	???????????B?????^?C????O?o??????????????D?D
		return 1;
	}
	return 0;
}

} // end of namespace Auxiliary
} // end of namespace yaneuraoGameSDK3rd
