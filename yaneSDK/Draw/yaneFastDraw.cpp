//
//	DirectDrawSurface and MemorySurface Wrapper
//

#include "stdafx.h"

#ifdef USE_FastDraw

#include "yaneDirectDraw.h"
#include "yaneFastDraw.h"
#include "yaneFastPlane.h"
#include "yaneGTL.h"
#include "../Window/yaneWindow.h"
#include "../AppFrame/yaneAppManager.h"	//	GetHWnd
#include "../AppFrame/yaneAppBase.h"

//////////////////////////////////////////////////////////////////////////////
//	CFastDraw : ?????x??????????
//////////////////////////////////////////////////////////////////////////////

namespace yaneuraoGameSDK3rd {
namespace Draw {

CFastDraw::CFastDraw() :
	m_DirectDrawBase(true),	//	DirectDraw emulation only
	//	????ADirectDraw??Emulation Only???????????I	
	m_Primary(GetThis()),
	m_Secondary256(GetThis()),
	m_Secondary(GetThis())
{
	CFastPlane::SetDefaultFastDraw(this);

//	m_nScreenXSize	= 640;
//	m_nScreenYSize	= 480;
	//	?????A????????????E?B???h?D?T?C?Y??????????????????????H
	IWindow* pWin = CAppManager::GetMyWindow();
	CWindowOption* opt;
	if (pWin!=NULL){
		opt = pWin->GetWindowOption();
	} else {
		opt = NULL;
	}
	if (opt==NULL){
		m_nScreenXSize	= 800;
		m_nScreenYSize	= 600;
	} else {
		m_nScreenXSize = opt->size_x;
		m_nScreenYSize = opt->size_y;
	}

	m_nScreenColor	= 16;
	m_bFullScr		= false;

	//	FullScr????t???b?v??g?p?B?g??????????g????????????
//	m_bUseFlip		= false;

	{
	RECT rc,rc2;
	::SetRect(&rc,0,0,0,0);
	::SetRect(&rc2,0,0,0,0);
	::AdjustWindowRect(&rc,WS_CAPTION | WS_SYSMENU,true);
	::AdjustWindowRect(&rc2,WS_CAPTION ,false);
	//	?t???X?N???[????????j???[?T?C?Y???m??Z?o??????A???j???[?????????(c)yaneurao'00/12/15
	//	?i??????j???[??????n?r????????O?O?G ?j
	m_nMenu = (rc.bottom-rc.top) - (rc2.bottom-rc2.top);
	}

	m_nSecondaryOffsetX = 0;
	m_nSecondaryOffsetY = 0;

	m_nBrightness	= 256;
	m_bLostSurface	= false; 

	m_hWnd	= CAppManager::GetHWnd();
	CAppManager::Add(this);
	CAppManager::Hook(this);		//	?t?b?N???J?n????

	//	?v???C?}????n?[?h?E?F?A?????????m??
	GetPrimary()->SetSystemMemoryUse(false);
//	GetPrimary2()->SetSystemMemoryUse(false);
	//	??????O??A?????V?X?e???????????m?????
	//	CFastPlane??A?f?B?t?H???g??V?X?e????????????A?????n?j

	//	?Z?J???_?????????A???????X?g?A?T?[?t?F?[?X????????
	//	?i??????AOnDraw??I?[?o?[???C?h????????????j
//	GetPrimary2()->SetAutoRestore(true);
	GetSecondary()->SetAutoRestore(true);

	// yaneGTL.h??g?p????A?u?????h?e?[?u??????????
	CFastPlaneBlendTable::InitTable();	
}

CFastDraw::~CFastDraw(){
	CAppManager::Unhook(this);		//	?t?b?N??????????B
	CAppManager::Del(this);
}

//////////////////////////////////////////////////////////////////////////////

int		CFastDraw::GetMenuHeight(){
//	???j???[?????????????A??????j???[????????
//	?i????????????O?j
	if (::GetMenu(m_hWnd)!=NULL) return m_nMenu;
	return 0;
}

//////////////////////////////////////////////////////////////////////////////

void CFastDraw::BeginChangeDisplay(){
	GetCriticalSection()->Enter();	//	?r?????b?N?????????

	m_bDisplayChanging = true;
	m_bChangeDisplayMode = false;
	if (GetDDraw()==NULL) return ;

	// FullScreenMode??Flip?p??A?^?b?`???????A???????K?v???????...
	//	?Z?J???_???A?N???b?p?A?v???C?}??????
 
	m_Secondary256.Release();
//	m_Secondary.Release();
	//	??????Z?J???_????A?V?X?e????????????????
	//	???z?Z?J???_???T?[?t?F?[?X??????????K?v??????
	//	?i?????A?????????????????AAutoRestore???????????j

	m_WindowClipper.Release();
//	m_Primary2.Release();
	m_Primary.Release();

	if (m_bFullScr) {	//	?????t???X?N???[?????[?h???????????K?v??????
		if (GetDDraw()->SetCooperativeLevel(m_hWnd,DDSCL_NORMAL)){
			Err.Out("CFastDraw::BeginChangeDisplay??SetCooperativeLevel????s..");
		}
		// ?E?B???h?D???[?h?????????A??????s????K?v????
		if (GetDDraw()->RestoreDisplayMode()){
			Err.Out("CFastDraw::BeginChangeDisplay??RestoreDisplayMode????s..");
		}
	}
}

void CFastDraw::TestDisplayMode(int nSX,int nSY,bool bFullScr,int nColor){
	if (!m_bDisplayChanging) return ; // already changing!!
	if (GetDDraw()==NULL) return ;

	// ?E?C???h?E???[?h??f?B?X?v???C???[?h???X???????
	m_bChangeDisplayMode |= (m_bFullScr!=bFullScr) || m_bFullScr;// ???
	if (m_bChangeDisplayMode) CAppManager::GetMyWindow()->SetResized(true);

	//	?????[?h???f??????...
	m_bFullScr	= bFullScr;

	if (!bFullScr) {
		// Window???[?h??w?????????d????????B
		if (GetDDraw()->SetCooperativeLevel(m_hWnd,DDSCL_NORMAL)){
			Err.Out("CFastDraw::TestDisplayMode??SetCooperativeLevel??DDSC_NORMAL????s");
			return ; // ??????????????????????????V????????????...
		}
	} else {
		if (GetDDraw()->SetCooperativeLevel(m_hWnd,DDSCL_EXCLUSIVE|DDSCL_FULLSCREEN)!=DD_OK){
			Err.Out("CFastDraw::TestDisplayMode??SetCooperativeLevel??DDSC_EXCLUSIVE????s");
			return ; // ????A?v???g?????????H
		}
		if (GetDDraw()->SetDisplayMode(nSX,nSY,nColor)!=DD_OK){
			Err.Out("CFastDraw::TestDisplayMode??SetDisplayMode????s");
			return ; // ???????H
		}
	}

	//	m_bUseFlip	: ?t???b?v???g?p???????H?i???[?U?[???v	?j
	//	m_bUseFlip2 : ?t???b?v???????n?[?h?E?F?A?I??g????A
	//				??????g???????true

//	m_bUseFlip2 = m_bUseFlip;

	bool bUseFilp = false;
	//	?v???C?}???T?[?t?F?[?X???
	if (m_Primary.CreatePrimary(bUseFilp,nSX,nSY)!=0) {
		Err.Out("CFastDraw::TestDisplayMode??CreatePrimary????s");
		return ;
	}

	//	?E?B???h?D???[?h????N???b?p???d?|????
	m_WindowClipper.Release();
	if (!bFullScr){
		if (m_WindowClipper.SetClipper(GetDDraw(),m_Primary.GetSurface(),m_hWnd)!=0) {
			Err.Out("CFastDraw::TestDisplayMode??Clip????s");
			return ;
		}
	}

/*
	if (m_bUseFlip2){
		if (m_Primary2.CreatePrimary2(&m_Primary,m_bUseFlip2)!=0){
			//	?????s???????A?t???b?v?g?p??????A?????
			m_bUseFlip2 = false;
		}
	}
*/

	bool b256 = m_Primary.GetSurfaceType()==2;
	if (b256) {
		m_Secondary.m_bSecondary256DIB = true;
		//	RGB555??DIB??????????I
	}

	//	?Z?J???_???T?[?t?F?[?X???
	if (m_Secondary.CreateSecondary(&m_Primary,bUseFilp)!=0) {
		Err.Out("CFastDraw::TestDisplayMode??CreateSecondary????s");
		return ;
	}
	// Ensure back buffer clears to black (not green); fixes main menu green rectangle
	GetSecondary()->SetFillColor(0);

/*
	// 256????????p???b?g?????????
	if (b256) InstallPalette();
*/

	//	?????A?t???X?N???[?????[?h??256?F?????A?t???b?v???g?p???????A
	//	Secondary256??s?v???????D?D?D
	if (b256) {
		//	256????p?T?[?t?F?[?X
		m_Secondary256.InnerCreateSurface(nSX,nSY,false,true);
	}

	//	??????E?B???h?D???[?h???f???????
	CAppManager::GetMyWindow()->ChangeScreen(bFullScr);
	CAppManager::GetMyWindow()->ChangeWindowStyle();

	m_bDisplayChanging	= false;	//	?????[?h???X??????I
	m_nScreenColor	= nColor;
	m_nScreenXSize	= nSX;
	m_nScreenYSize	= nSY;
	return ;
}

LRESULT CFastDraw::EndChangeDisplay(){
	struct tmpclass {
		tmpclass(CCriticalSection*c):c_(c){}
		~tmpclass() { c_->Leave();}
		CCriticalSection*c_;
	};
	tmpclass t(GetCriticalSection());
	//	??????????BeginChangeDisplay????????r?????b?N??????????

	if (GetDDraw()==NULL) return 1;
	
	if (m_bDisplayChanging) { // Change??????????I?I
		Err.Out("CFastDraw::BeginChangeDisplay?`EndChangeDisplay????s");
		return 1;
	}

	// ?E?C???h?E???[?h??A?f?B?X?v???C???[?h??????????????????
	if(m_bChangeDisplayMode) {// ???
		::Sleep(500);	//	?r?f?I???[?h???X??]?g???????\????????
	}

/*
	// ?p???b?g???\?z
	m_bBrightnessChanged = true;
*/

	// ???O??`????????W????????...
	CAppManager::GetMyWindow()->ShowCursor(!m_bFullScr);
	// ?E?B???h?D?T?C?Y???X
	CAppManager::GetMyWindow()->SetSize(m_nScreenXSize,m_nScreenYSize);
	// ?E?B???h?D?X?^?C?????X

	CAppManager::GetMyWindow()->ChangeScreen(m_bFullScr);
	//	??????????E?B???h?D?????m??????B
	//	?i?{????A??????E?B???h?E??u???[?h?L???X?g????K?v??????j
	CAppManager::GetMyWindow()->ChangeWindowStyle();

	// ?v???[?????\?z?i????????????????j
	RestoreAll();

	//	?i?p???b?g????A???C?Y???j
	// yaneGTL.h??g?p????ARGB555??256?????e?[?u?????????
	//	(???????A256?F???[?h??O??????A?????????????????)
	CFastPlaneBlendTable::OnChangePalette();	

	return 0;
}

/////// ?g?p??:p) ////////////////////////////////////////////////////////////

LRESULT CFastDraw::ChangeDisplay(bool bFullScr){
	if (GetDDraw()==NULL) return 1; //	??????????...
	BeginChangeDisplay();
		if (bFullScr) {
			TestDisplayMode(m_nScreenXSize,m_nScreenYSize,true,m_nScreenColor);
		}
		TestDisplayMode(m_nScreenXSize,m_nScreenYSize); // ?E?B???h?D???[?h
	if (EndChangeDisplay()) return 2;	//	?f?B?X?v???C???[?h??X????s
	return 0;
}

//////////////////////////////////////////////////////////////////////////////
//	?f?B?X?v???C???[?h??????X

LRESULT		CFastDraw::SetDisplay(bool bFullScr,int nSizeX,int nSizeY,int nColorDepth){
	if (nSizeX!=0) {
		m_nScreenXSize	=	nSizeX;
	}
	if (nSizeY!=0) {
		m_nScreenYSize	=	nSizeY;
	}
	if (nColorDepth!=0) {
		m_nScreenColor	=	nColorDepth;
	} else {
		m_nScreenColor	=	16; // fixed '01/04/08
	}
	ChangeDisplay(bFullScr);
	//	????p?????[?^???????????n??
	//	?im_bFullScr??????????[?h?????????????j
	return 0;
}

void		CFastDraw::GetDisplay(bool&bFullScr,int &nSizeX,int &nSizeY,int &nColorDepth){
	bFullScr		=	m_bFullScr;
	nSizeX			=	m_nScreenXSize;
	nSizeY			=	m_nScreenYSize;
	nColorDepth		=	m_nScreenColor;
}

void		CFastDraw::GetSize(int &nSizeX,int &nSizeY){	// GetDisplayMode??x,y???????????
	nSizeX			=	m_nScreenXSize;
	nSizeY			=	m_nScreenYSize;
}
	
bool	CFastDraw::IsFullScreen(){
	return		m_bFullScr;
}

void	CFastDraw::CheckSurfaceLost(){
	LPDIRECTDRAWSURFACE lpSurface = GetPrimary()->GetSurface();
	//	?V?X?e???????????T?[?t?F?[?X??Lost???????????O?O?G
	if (lpSurface==NULL) return ;
	if (lpSurface->IsLost()){
		ChangeDisplay(m_bFullScr);
		//	?v???C?}???T?[?t?F?[?X???\?z????s??????
	}
}

/*
int		CFastDraw::GetBpp(){	// ?????Bpp???
	return GetPrimary()->GetBpp();
}
*/

void	CFastDraw::SetBrightness(int nBright){
	if (m_nBrightness == nBright) return ;
	m_nBrightness = nBright;
}

//////////////////////////////////////////////////////////////////////////////

void	CFastDraw::SetOffset(int ox,int oy){
	//	?Z?J???_????]???I?t?Z?b?g
	m_nSecondaryOffsetX =	ox;
	m_nSecondaryOffsetY =	oy;
}

void	CFastDraw::OnDraw(LPCRECT lpRect,bool bLayerCallBack){

	if (CAppManager::GetMyWindow()->IsMinimized()) {
		return ;
	}
	//	????????????????`????????^?[??

	//	Menu??Popup????
	int nMenu = 0;
	//	FullScr??A???j???[?????A?}?E?X?????????j???[????????????????????...
	if (IsFullScreen() && ::GetActiveWindow()==m_hWnd) {
	//						?????????C???E?C???h?E???A?N?e?B?u(?_?C?A???O???????o???????)
		POINT point;
		::GetCursorPos(&point);
		if (point.y<m_nMenu) {
			if (::GetMenu(m_hWnd)!=NULL){
//				????????j???[?T?C?Y???m??Z?o??????A???j???[?????????(c)yaneurao'00/12/15
				nMenu = m_nMenu;
				//	Paint??????????[
//				::SetMenu(m_hWnd,GetMenu(m_hWnd));	//	???j???[?????`??
				::DrawMenuBar(m_hWnd);
			}
		}
	}
	
	//	?????A?T?[?t?F?[?X??????????????...
	if (m_bLostSurface) {
		if (!CAppManager::GetMyApp()->IsThreadValid()) return ;
		CheckSurfaceLost();
		//	????t???O??A???b?Z?[?W?|???v????
		//	???X?g?A?C?x???g????????????
		m_bLostSurface = false;
		return ;
	}
	
	LPDIRECTDRAWSURFACE lpPrimary = GetPrimary()->GetSurface();
	if (lpPrimary==NULL) return ;

	//////////////////////////////////////////////////////////
	//	Layer callback
	if ( bLayerCallBack ){
		//	Layer???Z?J???_????`????????O?O
		m_LayerList.OnDraw(GetSecondary());
		
		//	HDCLayer???Z?J???_????`????????O?O
		if (!m_HDCLayerList.IsEmpty()){
			HDC hdc = GetSecondary()->GetDC();
			if (hdc!=NULL){
				m_HDCLayerList.OnDraw(hdc);
				GetSecondary()->ReleaseDC();
			}
//			Invalidate();	//	???????????????A?????t???O?????
		}
		
		//	AfterLayer???Z?J???_????`????????O?O
		m_AfterLayerList.OnDraw(GetSecondary());

		//	?u???C?g?l?X???????A?Z?J???_????????
		RealizeBrightness(m_nBrightness);
	}
	//////////////////////////////////////////////////////////
	
	//	?v???C?}??????????????????^?[??
	//	if (!m_bDirty) return ;
	//	DirtyRect?????s?????????
	//	?????FullScreen??Flip???g???????X?V???????????????
	
	LPDIRECTDRAWSURFACE lpSecondary;
	CFastPlane* lpSecondarySurface;
	if (m_Primary.GetSurfaceType()==2){	//	8bpp??...
		//	Secondary??A????RGB555????]????????K?v????
		GetSecondary256()->BltFast(GetSecondary(),0,0);
		lpSecondary = GetSecondary256()->GetSurface();
		lpSecondarySurface = GetSecondary256();
	} else {
		lpSecondary = GetSecondary()->GetSurface();
		lpSecondarySurface = GetSecondary();
	}
	if (lpSecondary==NULL) return ;

	RECT r; // source rect
	::SetRect(&r,0,0,m_nScreenXSize,m_nScreenYSize);
	
	if (m_nSecondaryOffsetX || m_nSecondaryOffsetY) {
		//	?]????I?t?Z?b?g????????????????H
		RECT r2; // distination rect
		if ( lpRect == NULL ){	// ?????X?V???H
			::SetRect(&r2,0,0,m_nScreenXSize,m_nScreenYSize);	//	????T?C?Y?????????
			//	a clipping algorithm
			//		between the same size rect (C) yaneurao'1999
			if (m_nSecondaryOffsetX>0) {
				r.right		-= m_nSecondaryOffsetX;
				r2.left		+= m_nSecondaryOffsetX;
			} else {
				r.left		-= m_nSecondaryOffsetX;
				r2.right	+= m_nSecondaryOffsetX;
			}
			if (m_nSecondaryOffsetY>0) {
				r.bottom	-= m_nSecondaryOffsetY;
				r2.top		+= m_nSecondaryOffsetY;
			} else {
				r.top		-= m_nSecondaryOffsetY;
				r2.bottom	+= m_nSecondaryOffsetY;
			}
			
			if (CWindow::IsFullScreen()){
				// ?t???X?N???[??????ABlt????I
				DDBLTFX fx;
				ZERO(fx);	//	????????
				fx.dwSize = sizeof(fx);
				fx.dwFillColor = lpSecondarySurface->GetFillColor();
				RECT br;
				::SetRect(&br,0,nMenu,m_nScreenXSize,r2.top);					//	????
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				//	main??
				lpPrimary->BltFast(r2.left,r2.top,lpSecondary,&r,DDBLTFAST_WAIT);
				::SetRect(&br,0,r2.top,r2.left,r2.bottom);				//	?????
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				::SetRect(&br,r2.right,r2.top,m_nScreenXSize,r2.bottom);	//	?E???
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				::SetRect(&br,0,r2.bottom,m_nScreenXSize,m_nScreenYSize);	//	?????
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				
			} else {
				// DirectDrawClipper???p??????Blt??????????????B
				// ???????A?????[??????B?????????????~????>Clipper?N?I
				POINT cp;
				cp.x = cp.y = 0;
				::ClientToScreen(m_hWnd,&cp); // ?N???C?A???g?E?B???h?D???`??????I
				
				DDBLTFX fx;
				ZERO(fx);	//	????????
				fx.dwSize = sizeof(fx);
				fx.dwFillColor = lpSecondarySurface->GetFillColor();
				
				RECT br;
				::SetRect(&br,0,0,m_nScreenXSize,r2.top);					//	????
				::OffsetRect(&br,cp.x,cp.y);
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				
				//	main??
				br = r2;
				::OffsetRect(&br,cp.x,cp.y);
				lpPrimary->Blt(&br,lpSecondary,&r,DDBLT_WAIT,NULL);
				
				::SetRect(&br,0,r2.top,r2.left,r2.bottom);					//	?????
				::OffsetRect(&br,cp.x,cp.y);
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				::SetRect(&br,r2.right,r2.top,m_nScreenXSize,r2.bottom);	//	?E???
				::OffsetRect(&br,cp.x,cp.y);
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
				::SetRect(&br,0,r2.bottom,m_nScreenXSize,m_nScreenYSize);	//	?????
				::OffsetRect(&br,cp.x,cp.y);
				lpPrimary->Blt(&br,NULL,NULL,DDBLT_COLORFILL|DDBLT_WAIT,&fx);
			}
		}else{
			// ?????X?V
				r = *lpRect;	// source rest;
				r2 = *lpRect;	// dest	 rest;
			if (CWindow::IsFullScreen()){
				// from CPlane DRAW_CLIPPER
				RECT& sr = r;			
				int x = m_nSecondaryOffsetX;
				int y = m_nSecondaryOffsetY;
				{
					RECT clip;
					::SetRect(&clip,0,0,m_nScreenXSize,m_nScreenYSize);
					int x2,y2;													
					x2 = x + sr.right - sr.left; /* x + Width  */				
					y2 = y + sr.bottom - sr.top; /* y + Height */				
					if (x2<clip.left || y2<clip.top								
						|| x>=clip.right || y>=clip.bottom) return;	 /* ???O */ 
					int t;														
					t = clip.left-x;										
					if (t>0)	{ sr.left	+= t;	x = clip.left;	}		
					t = clip.top -y;										
					if (t>0)	{ sr.top	+= t;	y = clip.top;	}		
					t = x2-clip.right;										
					if (t>0)	{ sr.right	-= t;	x2= clip.right; }		
					t = y2-clip.bottom;										
					if (t>0)	{ sr.bottom -= t;	y2= clip.bottom;}		
					if (sr.right<=sr.left || sr.bottom<=sr.top) return; // invalid rect
				}
				lpPrimary->BltFast(x,y,lpSecondary,&r,DDBLTFAST_WAIT);
			}else{
				// ?I?t?Z?b?g?]????????X?V????A???????w?i??`?????
				// DirectDrawClipper???p??????Blt??????????????B
				// ???????A?????[??????B?????????????~????>Clipper?N?I
				POINT cp;
				cp.x = cp.y = 0;
				::ClientToScreen(m_hWnd,&cp); // ?N???C?A???g?E?B???h?D???`??????I
				::OffsetRect(&r2,m_nSecondaryOffsetX,m_nSecondaryOffsetY);
				::OffsetRect(&r2,cp.x,cp.y); 
				lpPrimary->Blt(&r2,lpSecondary,&r,DDBLT_WAIT,NULL);
			}
			
		}
		
	} else {
		//	?]???I?t?Z?b?g???w??????????t?c?[???
		
		if (CWindow::IsFullScreen()){
			if (/*m_bUseFlip2*/ false && lpRect == NULL ){
				lpPrimary->Flip(NULL,DDFLIP_WAIT);
			} else {
				if ( lpRect != NULL ){
					r = *lpRect;
				}
				//	??????A???j???[?\??????I(yane'02/01/13)
				if ( nMenu && nMenu > r.top ) {
					r.top = nMenu;
				}
				lpPrimary->BltFast(r.left,r.top,lpSecondary,&r,DDBLTFAST_WAIT);
			}
		} else {
			// DirectDrawClipper???p??????Blt??????????????B
			POINT cp;
			cp.x = cp.y = 0;
			::ClientToScreen(m_hWnd,&cp);
			if ( lpRect != NULL ) {
				r = *lpRect;
			}
			RECT sr = r;
			::OffsetRect(&sr,cp.x,cp.y);
			lpPrimary->Blt(&sr,lpSecondary,&r,DDBLT_WAIT,NULL);
		}
	}
	
//	m_bDirty = false;
}

//////////////////////////////////////////////////////////////////////////////
void	CFastDraw::RealizeBrightness(int nBrightness){
	if (m_nBrightness==256) return ;
	//	??????????????O?O?G?@???????O?O?G
	GetSecondary()->FadeEffect(nBrightness);
}

//////////////////////////////////////////////////////////////////////////////

void	CFastDraw::RestoreAll(){ // ?S?v???[????????[?h
	GetFastPlaneList()->for_each(&CFastPlane::Restore);
	return ;
}

//////////////////////////////////////////////////////////////////////////////
LRESULT		CFastDraw::WndProc(HWND hWnd,UINT uMsg,WPARAM wParam,LPARAM lParam){

	switch(uMsg){
	case WM_PAINT : {
		//	dirty rect??????
//		m_bDirty = true;
//		if (!CWindow::IsFullScreen()) OnDraw();	//	???A??`???????B
//		OnDraw();
		/*
			????O?????????????A?????R?????g???O????????
			WM_PAINT??????????GetDC??g?????????????K?v?B
			?iGetDC????????f?o?C?X?R???e?L?X?g??`?????WM_PAINT????????????j
			WM_PAINT?????????WM_PAINT????????????A?A?v???P?[?V??????WM_PAINT??
			?????????????????I
		*/
		return 0;	//	DefWindowProc?????o????s???B
					//	????????o?????????????xWM_PAINT???????????
					}

	case WM_ACTIVATEAPP: {
		UINT bActive = wParam;
		if(bActive) {
			//	???b?Z?[?W?|???v????????A???[?J?[?X???b?h??????X?g?A?????...
			m_bLostSurface = true;
		}
		return 0;
						 }

	case WM_PALETTECHANGED: {
		//	?i?p???b?g????A???C?Y???j
		// yaneGTL.h??g?p????ARGB555??256?????e?[?u?????????
		CFastPlaneBlendTable::OnChangePalette();	
		return 0;
							}

	} // end switch


	return 0;
}

} // end of namespace Draw
} // end of namespace yaneuraoGameSDK3rd

#endif // USE_FastDraw
