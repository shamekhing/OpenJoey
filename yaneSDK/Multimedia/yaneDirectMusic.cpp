// DirectMusic Wrapper

#include "stdafx.h"
#include "../Auxiliary/yaneCOMBase.h"
#include "../AppFrame/yaneAppManager.h"
#include "../Multimedia/yaneDirectSound.h"
#include "../Multimedia/yaneDirectMusic.h"

#if USE_DirectMusic

namespace yaneuraoGameSDK3rd {
namespace Multimedia {

///////////////////////////////////////////////////////////////////////////

bool CDirectMusic::CanUseDirectMusic(){
	//	DirectMusic???g????�?????????????????
	static bool bFirst = true;
	static bool bUse   = false;

	if (bFirst){	//	?????P??????????
		bFirst = false;
		CCOMObject<IDirectMusicPerformance*> obj;
		bUse = obj.CreateInstance(
			CLSID_DirectMusicPerformance,IID_IDirectMusicPerformance)==0;
	}
	return bUse;
}

///////////////////////////////////////////////////////////////////////////

CDirectMusic::CDirectMusic(CDirectSound* p/*=NULL*/) :
	m_nStatus(0),m_lpDMusic(0)
{
	if (GetDirectMusicPerformance()->CreateInstance(
		CLSID_DirectMusicPerformance,IID_IDirectMusicPerformance)!=0){

		m_nStatus = 1;
		return ;
	}

	// DirectSound??Attach???????
	if (p&&p->Get()){
		m_pDirectSound = p->Get();
	}

	//	?????DirectSound????????????
	//	m_lpDMusic = NULL;	//	??????????????????bug??B
		//	????l??????n??????????????v??????????A
		//	??????????>DirectMusic
	if (FAILED(GetDirectMusicPerformance()->get()->
			Init(&m_lpDMusic,GetDirectSound(),NULL))){
		m_nStatus = 2;
		m_lpDMusic = NULL;	//	NULL???????
		return ;
	}

	//	???????A?|?[?g?i?V???Z?T?C?U?j??I????s???
	if (FAILED(GetDirectMusicPerformance()->get()->AddPort(NULL))){
	//	???m_lpDMusic????????????A
	//	?????�????????|?[?g???????????
			//	?T?[?h?p?[?e?B????\?t?g?V???Z??f?B?t?H???g??
			//	?I?????????????????????A???s????
			//	??????h???}?C?i??j
	}

	if (GetDirectMusicLoader()->CreateInstance(
		CLSID_DirectMusicLoader,IID_IDirectMusicLoader)!=0){
		m_nStatus = 3;
	}

	//	????????????s??????Z?O?????g??L???b?V????????
	//	???????????o?O??????O?O?G
	GetDirectMusicLoader()->get()->EnableCache(GUID_DirectMusicAllTypes,false);
	GetDirectMusicLoader()->get()->EnableCache(CLSID_DirectMusicSegment,false);
}

CDirectMusic::~CDirectMusic(){
	GetDirectMusicLoader()->Release();	//	Loader?????????????????

	if (GetDirectMusicPerformance()!=NULL){
		GetDirectMusicPerformance()->get()->CloseDown();
		GetDirectMusicPerformance()->Release();
	}
}

} // end of namespace Multimedia
} // end of namespace yaneuraoGameSDK3rd

#endif // USE_DirectMusic
