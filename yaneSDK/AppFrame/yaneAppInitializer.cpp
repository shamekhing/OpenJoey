#include "stdafx.h"

#include "yaneAppInitializer.h"
#include "../Thread/yaneThread.h"
	//	?I???????????????X???b?h??I?????m?F????????K?v????????
	//	??????CThreadManager??????A?N?Z?X????K?v??????

namespace yaneuraoGameSDK3rd {
namespace AppFrame {

//	static member..
CAppInitializer* CAppInitializer::m_vObj=NULL;
singleton<CAppCallbackList>	CAppInitializer::m_AppCallBackObj;
bool CAppInitializer::m_bMultiThread = false;

#ifndef COMPILE_YANE_PLUGIN_DLL
//	WinMain??????p?????[?^????????n?????B
CAppInitializer::CAppInitializer(HINSTANCE hInstance,HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nCmdShow){
	//	?p?????[?^??????????:p
	m_hInstance		=	hInstance;
	m_hPrevInstance	=	hPrevInstance;
	m_lpCmdLine		=	lpCmdLine;
	m_nCmdShow		=	nCmdShow;

	m_vObj = this; // ?O??????static??A?N?Z?X??????????????

	m_bMultiThread = true;
	//	??????~??A?}???`?X???b?h????B
	//	????????latch???????A???????

	IThread::setThread(NULL);

	GetCallbackObj()->InitCallback();
}

#else

//	DllMain?????p?????[?^????????n????l?IDll????????????????????
CAppInitializer::CAppInitializer( HANDLE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved){
	//	?p?????[?^??????????:p
	m_hInstance		=	(HINSTANCE)hModule;
	m_hPrevInstance	=	(HINSTANCE)hModule;
	m_lpCmdLine		=	(LPSTR)lpReserved;
	//	??????new?????ok
	m_vObj = this; // ?O??????static??A?N?Z?X??????????????
}

#endif

CAppInitializer::~CAppInitializer(){
#ifndef COMPILE_YANE_PLUGIN_DLL
	CThreadManager::GetObj()->WaitAllThreadEnded();
	//	??????X???b?h??I??????
#endif
	//	????????A?V???O???X???b?h???[?h????
	m_bMultiThread	= false;
	GetCallbackObj()->ExitCallback();
}

void	CAppCallbackList::InitCallback(){
	//	RegistInitCallback????????????????o??

	//	????????A????V???O???X???b?h????
	//	CriticalSection???g?p????K?v?????

	//	?R?[???o?b?N?\??????�????o??
	GetInitCallbackList()->for_each(&function_callback::run);
}

void	CAppCallbackList::ExitCallback(){
	//	RegistExitCallback????????????????o??

	//	????????A????V???O???X???b?h????
	//	CriticalSection???g?p????K?v?????

	//	?R?[???o?b?N?\??????�????o??
	GetExitCallbackList()->for_each(&function_callback::run);
}

} // end of namespace AppFrame
} // end of namespace yaneuraoGameSDK3rd

//////////////////////////////////////////////////////////////////////////////

